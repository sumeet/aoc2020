DEMO = "Tile 2311:
..##.#..#.
##..#.....
#...##..#.
####.#...#
##.##.###.
##...#.###
.#.#.#..##
..#....#..
###...#.#.
..###..###

Tile 1951:
#.##...##.
#.####...#
.....#..##
#...######
.##.#....#
.###.#####
###.##.##.
.###....#.
..#.#..#.#
#...##.#..

Tile 1171:
####...##.
#..##.#..#
##.#..#.#.
.###.####.
..###.####
.##....##.
.#...####.
#.##.####.
####..#...
.....##...

Tile 1427:
###.##.#..
.#..#.##..
.#.##.#..#
#.#.#.##.#
....#...##
...##..##.
...#.#####
.#.####.#.
..#..###.#
..##.#..#.

Tile 1489:
##.#.#....
..##...#..
.##..##...
..#...#...
#####...#.
#..#.#.#.#
...#.#.#..
##.#...##.
..##.##.##
###.##.#..

Tile 2473:
#....####.
#..#.##...
#.##..#...
######.#.#
.#...#.#.#
.#########
.###.#..#.
########.#
##...##.#.
..###.#.#.

Tile 2971:
..#.#....#
#...###...
#.#.###...
##.##..#..
.#####..##
.#..####.#
#..#.#..#.
..####.###
..#.#.###.
...#.#.#.#

Tile 2729:
...#.#.#.#
####.#....
..#.#.....
....#..#.#
.##..##.#.
.#.####...
####.#.#..
##.####...
##..#.##..
#.##...##.

Tile 3079:
#.#.#####.
.#..######
..#.......
######....
####.#..#.
.#...#.##.
#.#####.##
..#.###...
..#.......
..#.###...
"

INPUT = "Tile 2797:
.#...#...#
##........
#...#.....
#.#..#...#
##..#.....
#.....#..#
..#......#
..........
#......#..
...######.

Tile 3137:
.#####...#
..........
#.#......#
.....#..#.
##......##
..........
##.......#
........#.
#.....##.#
.#.##..#.#

Tile 2633:
##.##.#..#
..#......#
##.......#
#...#....#
....#..#..
#....#....
#.........
...#...#..
##.....#..
.####..###

Tile 1879:
.#.#.#..#.
#......#.#
....#..#.#
.....#.##.
.......#.#
##....#.#.
#....#..#.
.......#..
.#.....##.
#.####.#.#

Tile 1429:
..####.##.
.......##.
.###..#..#
.........#
##.....#.#
#..#...###
.#......#.
#...#.#...
#..#.....#
#..##.####

Tile 2857:
###.#....#
#....#..#.
..#...#.##
.#.......#
#...#.....
.........#
.........#
#........#
..#...#...
#.#.#####.

Tile 3803:
##...#.#.#
.#..#.....
.#...#....
#........#
#........#
#...###...
...##.#..#
#.........
..........
#...##.#..

Tile 1697:
..#.##.###
...#.#....
#.....##..
#........#
..#..#.##.
#..##.#...
#......###
#.#......#
..........
..##.###.#

Tile 3823:
##..####.#
..#.....##
.....####.
......###.
#..##.....
..........
#...#...##
..........
........##
.####....#

Tile 1619:
.##...#..#
......#.#.
.....#....
.......#..
#........#
......##..
.##..#...#
#.........
...##.....
....##.#.#

Tile 3257:
.#.#.#.###
....#..##.
#.#...#...
#.........
.......###
.#........
#......###
........#.
###......#
###..#####

Tile 3061:
..#.####..
#...##....
#.....#.##
#.........
#.........
.#..##.#..
......##..
#......#..
#..#....#.
.......##.

Tile 2371:
#..####.#.
#.........
#......#..
#.......#.
..#.#..#..
#...#.###.
...#...##.
#....#..##
##.#...##.
...###..#.

Tile 3919:
####....##
#.....#..#
#..##.....
.........#
#...#.....
#........#
#..#.##..#
#...#.#...
#.........
#..#.##..#

Tile 2063:
##.#.#.#..
..#..#.#..
....#.#.##
#...#.....
.........#
#....#....
......#...
#........#
#........#
#.##...##.

Tile 3637:
#..#..##..
..#.#...#.
......#..#
..#......#
#....#....
.........#
#..#...###
#.#.#..#..
#..#..#...
....##..##

Tile 2393:
#..#....##
....#.#...
.......#.#
..........
#.....#...
......#...
#....#..#.
...###....
#........#
#.#.##....

Tile 1381:
..##.###..
.#.......#
#...#.....
#..#.#..##
#....##.##
#...##.#.#
........#.
#......#.#
#...#..#.#
##.##..###

Tile 2647:
...#.##.##
#.......##
#....####.
.......###
#.#....#..
#........#
....##...#
..........
..#.......
....######

Tile 2087:
#..#####.#
#..#......
.....#....
......#...
......#...
#..##...#.
........##
#.........
#.........
#.#####.##

Tile 2351:
...###..#.
.........#
#...#...#.
.......#.#
#......#..
#.....#.#.
##......#.
#...#...#.
....##..##
##.#.....#

Tile 1163:
.....#...#
....#....#
..#......#
.....###..
#....###.#
....###.##
#......##.
#........#
..........
###.#.##.#

Tile 3877:
##...##...
#.........
....#.#.##
..#...#.##
#......#..
#.......#.
#..#...#..
#...##..##
#...#....#
#.##...###

Tile 3697:
###.#.#...
..##......
.......#.#
...#.....#
..........
.#....#..#
....#..###
.#..#.....
#.......##
...#.###..

Tile 3329:
####.#...#
#......###
#.....###.
#..#..#..#
#....#...#
##..####..
..#.#...#.
####......
##....##.#
.#...#.##.

Tile 1103:
###....##.
..#......#
#.#......#
#....##.#.
#..##....#
..##..#..#
##..##...#
#....#....
..#...##..
#######..#

Tile 2557:
#.#.##.##.
......#..#
#.##.##..#
...#.....#
..#..#...#
###.#...##
...##.....
#.#......#
#.....#..#
..##.#..#.

Tile 1291:
.#.....#..
.........#
..#......#
##.......#
..#......#
#....#..##
##...#....
.....#..#.
...#.....#
.####.##..

Tile 3469:
#.###..##.
.#.....#..
#.........
###...#..#
#.#.......
#..#...#..
#......#..
.........#
........##
####..##.#

Tile 1741:
##...#.###
#.#.#.....
#.##.#...#
.....#..#.
#.........
...#..##.#
#..#....##
#......#..
#.#.......
..#####...

Tile 2609:
....#.####
.........#
#.#......#
..........
.....#..#.
#........#
..#......#
#....##..#
.......#..
..#....##.

Tile 3863:
.##.#.#...
.#......#.
..#..#..##
..........
.........#
#.......##
#..#.....#
##....#.#.
#....##..#
.#..####.#

Tile 3041:
#.##......
#.#......#
#...#...#.
....#..#.#
#.......#.
#.......#.
........#.
.......#.#
##.#......
..####..#.

Tile 3701:
#..#.#..##
..##.....#
#..#.....#
..........
....#....#
.#.#.#....
#........#
#....##.#.
..#..#....
.##....#..

Tile 3251:
..#.##.##.
##..#.##.#
..#.#.....
#..#......
#..#.##.#.
..........
.##...##..
#...##...#
.#.......#
........#.

Tile 2539:
.#.###..##
........#.
..#.....#.
........#.
##..#...#.
#........#
#.........
......#...
.#.#..##..
.#....##.#

Tile 2099:
#......##.
#..#.#..##
.#...#...#
.##.....#.
..#..#..##
##.###...#
.......#..
#.....#..#
....#...#.
##..##.##.

Tile 1511:
....#.#..#
#.....#...
.#....#..#
.......#..
..#..#....
.#........
.........#
....##..#.
#....#.#..
####..#.#.

Tile 2029:
#....#.#..
#.........
..#.##....
#...#.....
#...##..#.
...#......
#..#..##.#
#...#...##
........##
.#####.#.#

Tile 3217:
..####.##.
..##...##.
.#..#.##..
.#..#....#
.........#
..#.#..#..
#..#.##...
#.##......
.#.#......
#.#.#.#...

Tile 1321:
#.####..##
#.......#.
.........#
......#...
###..#.#.#
##...#...#
......#.##
.#........
.........#
.#.####...

Tile 1259:
.....#...#
..#...##.#
#.#.#.#..#
#.......##
....#....#
....#..#.#
....##....
.....#...#
#.....#...
#.#.#..##.

Tile 2203:
####.#..#.
..........
.....#....
.#....#...
#.#.#....#
#.........
#.........
..#.......
....#....#
#..###..##

Tile 3847:
..##.#....
#..#.....#
...#.#...#
..##......
.###.#....
##.......#
#....#...#
...#....##
...#..#.#.
#.......##

Tile 1447:
....#..##.
#....#.#..
##.#.....#
..#......#
...#.....#
......#..#
####...#..
#.......##
...###.##.
.####....#

Tile 2381:
...####.#.
.........#
......#.#.
..#..#....
.........#
#.........
#..###....
..#.......
#..#.....#
##..#..#.#

Tile 1319:
.####.#...
#.##....##
.........#
#.#.......
..........
#.....###.
....#....#
##....###.
#.#.#..#..
.#.#...##.

Tile 2897:
###.#..##.
##........
###..#...#
#.....#...
##.#.....#
##..#....#
#.#.#.#..#
.##.###...
#..#......
.#.....##.

Tile 3833:
.##.#.##.#
##.#.#.#.#
.........#
.#........
#...#..###
#.##..#..#
.....#...#
#..#..#...
...####..#
.#......##

Tile 1699:
#.#.###..#
.#.#.....#
..#..#.#.#
........#.
..#......#
#..#......
.##...###.
#...#.#..#
#.....#..#
.#..####.#

Tile 2671:
#...#####.
#.....#...
#.......##
.##..#.##.
........##
...###.###
.#.#.#...#
###.......
.#.##....#
#.#.#.###.

Tile 1201:
.....##...
........##
.....#.#..
#........#
....#....#
.......#..
...#.#.##.
.......#.#
....#..#.#
####..#.##

Tile 2141:
###..#..#.
##......#.
...#..##.#
###.###..#
....##.#..
#...#....#
#.......#.
#..#......
#.##......
####....#.

Tile 1289:
#..#####..
#........#
#....##...
......#...
#.........
#........#
...#..#..#
##.#...##.
....#..#.#
#.##.###.#

Tile 1831:
.#..##.##.
#.......#.
#.......##
#......#..
#..#...#.#
....#..###
#.........
#...#..#..
#.......#.
#.####.#.#

Tile 1117:
.#....#..#
.....#..#.
#...#....#
##....#.#.
##.....#.#
##.#.#.#..
#.#.#...#.
#...#....#
#...###...
.#..#....#

Tile 1549:
####.#..##
.........#
#.....#.#.
..........
#.........
#...#.#.##
#.#.##...#
#.#....###
.#.#......
..#.#.....

Tile 1373:
##.#.##.#.
#.........
.....#..##
..#......#
#....#....
.....##..#
#..#..#..#
#..#.#....
#.#..#..#.
##.#....##

Tile 1663:
.#.##..##.
#....#....
#.#..##.##
##.#.#.###
....##...#
.#....#..#
#...#.#..#
#..#.####.
#.....#..#
#...##.###

Tile 3037:
#.###....#
#........#
....#.#..#
#...#.....
...###.#..
#.#..#...#
#........#
#....#...#
.##......#
#...#.#..#

Tile 3067:
.##.####.#
..........
...##.#.##
#......###
#....#..##
.##.......
#.....#..#
#.....#...
##...##...
..##..##.#

Tile 3727:
....##...#
....#.#..#
#.#....#..
.....#.#.#
#.......#.
#....#.#.#
......#...
#.#......#
#.......##
###.#..#..

Tile 2963:
.###.####.
...#.....#
.#......#.
..#..#..##
#..#....##
.#..#....#
#...#....#
#..#.#...#
..........
#.....##..

Tile 1069:
###...#.#.
##.##...##
#.###.#.#.
#...##...#
.......#.#
#.#..#...#
.#....#...
.#....#.##
###....#..
.#...#.###

Tile 3163:
##..##.##.
##.##...##
#.##...###
#...#.#.##
#.#..##.##
...#.#.###
##........
.........#
#.....#...
..#.###.#.

Tile 1721:
##.##.#.##
#..##.##..
##.#...#.#
..#......#
#..#......
##.......#
###......#
...#.....#
#.##...#.#
....###.#.

Tile 1039:
#..###.##.
...##.#..#
#..##....#
#.##..#..#
#...#....#
#.....#.##
.........#
#...#....#
#.##......
...##.#.#.

Tile 2383:
#.##..#..#
....##...#
#......#..
..#......#
.#....#..#
#..#....##
.......#..
#.#.......
#...#.....
.###.##...

Tile 3181:
.#.##.##.#
......#...
..#.#..#..
##.......#
......#.##
#...#....#
......##..
#.##......
#.........
..##..#.#.

Tile 1823:
#..#.#.#.#
#..##....#
#..#.....#
#.....#...
......##..
...#...#.#
#........#
.#........
#.#...#...
##..##..#.

Tile 3623:
..#..###.#
...#...#..
#.......#.
#....#..#.
....##..#.
.....#.#..
.......#..
#.#...#...
##.##..#..
....##..#.

Tile 3169:
##..#.#...
#..##....#
.........#
.......#..
.........#
#.........
..#.....##
#..#.....#
###.#...#.
....#..##.

Tile 1597:
...#.###.#
..##......
#.#..#...#
....#.....
##........
#...#.#...
##.......#
#.........
#.........
.#.##..#..

Tile 2677:
.#..##.##.
#..#...#.#
#.##...##.
.......#..
.#.#..##..
#....#.#.#
..........
.......#.#
.......#..
#####..#..

Tile 1087:
.##.#...##
..#.......
......#...
.#.....###
#......#..
#.#......#
.#....#..#
.....##.#.
#..###..##
..#.#..#.#

Tile 3461:
#...#.#...
#.........
#.#.#.#..#
.#......#.
#.#..#..#.
.#......##
.........#
...#..##.#
#...##....
.###....##

Tile 3779:
###..###..
#..#....##
###.......
..........
##.#......
##........
.#.....#.#
.#........
.....#.#.#
##.#.###.#

Tile 1543:
####..#.#.
....#.....
.#..#.....
#.#....#..
.#..##..#.
#......#..
#...#.....
##....#...
#.....##.#
##.#..###.

Tile 3307:
.###...##.
#....#....
.#..#....#
##...##..#
.#........
..........
.........#
....#....#
#.##.#.#.#
.##...#.#.

Tile 1499:
#.###..#.#
#....#...#
.#........
..##......
.........#
.#.##.#..#
#....#...#
#..#......
..#.#.....
.###.####.

Tile 3433:
.#.....#..
..#.......
#.....##.#
##........
.#.#......
#........#
.#...#.###
...#......
...#......
##.#...##.

Tile 1571:
#.#.###...
#..#.#....
..#......#
.##..#..##
#...#....#
#...#....#
#...#.....
..##..#...
#........#
.##..####.

Tile 1277:
##.##..#.#
....#..#..
#.....#...
#..#....##
.....#.##.
......##.#
#....#.#..
#.........
#....#...#
.#.#.###.#

Tile 1901:
###.#.##.#
.......#.#
#.....#..#
#.#...#..#
..#....#.#
.#.......#
.........#
.#.....##.
.#..#.#...
#..#.###.#

Tile 2999:
..#..#.###
##.......#
........#.
#........#
.#...#...#
......#..#
##........
##.#..#...
##....##..
.#.#.##...

Tile 2659:
..##.....#
...##.....
#..##.#..#
#..#.#.#.#
.....#....
......#...
..#.#.#...
......#.#.
#.....#...
.#.#.##..#

Tile 1229:
##..#...##
........#.
#......#..
##...#...#
.......##.
..........
...##...#.
#..#...##.
#....#...#
##.##.##.#

Tile 2579:
#.#.#...#.
.........#
.#.......#
....##...#
.....#...#
.##.#.....
##.......#
##......#.
###....#..
..#.##..#.

Tile 2089:
######.###
#..#.....#
#..#.###.#
#...#....#
#........#
.#........
.....#....
.....#.###
#......#..
#.#..##.#.

Tile 2909:
######.##.
...#......
........##
#.........
#....#...#
#...#.....
.......#.#
..#.#...#.
..#..#...#
###...#.##

Tile 2447:
#.........
#..#....#.
......#..#
.#........
###.....#.
......#...
###....#.#
..........
#.......#.
#..#...#..

Tile 1471:
###..##...
#..##..#..
....##...#
.##.#....#
#..#...#..
#.#.......
.........#
#.###.....
#...##...#
##.....###

Tile 1151:
.#.#....##
...#.#...#
##..##...#
#.#.#.....
#......#.#
#........#
..#....##.
#.....#...
....##.#..
..#...#.#.

Tile 1279:
#..#.##...
.....#...#
.........#
#...##....
#....#.#.#
..#.....#.
.##......#
#........#
..#..#....
.....#.#..

Tile 1451:
...#....#.
#..#.....#
.......#..
###....###
..###.....
#.........
#...##...#
...#..#.##
#.........
...##..#.#

Tile 3631:
..##.###.#
..###...#.
.#.##..###
..##.###..
#........#
#.##.#..##
##....#...
.......#.#
#..#.....#
.#.#..#...

Tile 1013:
.#.#.#..##
..#...#.##
##...#.#..
.#.#..#..#
...##.#...
#....#...#
.......#.#
........#.
..####...#
..##..#...

Tile 1709:
.##..#.##.
......#..#
....#..###
....#.#...
#....##..#
#..#....#.
...#....#.
#...#...#.
#...#.#...
.#....#...

Tile 3643:
.#..#...##
##..##...#
##..#..#.#
#........#
..#...#...
#.........
......#...
.....##.#.
..........
#.##..###.

Tile 2789:
##.##.#.##
...#.....#
...#.....#
.#....#..#
#.........
#...#.#.##
.........#
#.###....#
.#.....#.#
##.##....#

Tile 1097:
##.#####..
#.#..#....
#....#....
#.....#...
.......#..
##....#...
...#....##
.........#
.#........
.#...#....

Tile 2711:
..##..#..#
.........#
...##...#.
###....#.#
...#..#..#
.....###..
#.......#.
###......#
.###.#....
.#..######

Tile 3529:
###.##.##.
#........#
.....#...#
.#####..##
.#..#.##..
....##....
..#.#.#..#
#..#...#.#
#.....#..#
#....###.#

Tile 3167:
#....#.###
.#......##
#........#
....##.#.#
#.#.......
.#.#....#.
#.........
#..#.#...#
...#......
###.#.#..#

Tile 1297:
.#.#....#.
....#...#.
.#.#......
#...#....#
#.#....#..
#.....#...
.#.#.....#
...#.#...#
.#.......#
.......##.

Tile 3499:
#...##..##
#.....#...
#..#..#...
.......##.
.........#
....#.....
#..#......
#...#.....
....#....#
...##..#..

Tile 1871:
##.#.#####
..#......#
#.##.....#
...#......
..#...#..#
#........#
....#....#
#.#......#
#..##..#..
#...##....

Tile 2131:
###...#.##
#....#....
##...#...#
..##.###..
...#...##.
.#........
#..#.#...#
.#.###...#
##.....###
.....##.##

Tile 2663:
#######.#.
#...###..#
#.#......#
#..#.#....
.....#.#..
###.......
#...#.....
#.....#...
..###.#...
###..#.###

Tile 3301:
#.####.#..
..........
......#...
...#.....#
#.........
..........
#...#....#
#....#....
.##...#..#
.##.#.#..#

Tile 1483:
#.#####.##
..#...#...
#.......#.
#.......#.
...#....##
......#.#.
#.##.....#
...##....#
#..#......
...#.##.##

Tile 3371:
.#..##..##
#..#....##
..##.....#
#.........
..........
##........
..#.#...##
#.........
#.....#...
##...#..##

Tile 3511:
..#..#...#
#..#.....#
....#.#..#
#.........
...#.....#
..........
#..#......
#..#.....#
...#....#.
.#######.#

Tile 1327:
...#.#..##
#...##...#
#......###
#..#.....#
##....#...
#..#....#.
#.........
.#...#....
..........
...##.#.##

Tile 2269:
#.###.####
#.......#.
.....#....
#......#..
#.#....#..
##...#.#..
.#.##.....
##.##....#
..#.......
.####..###

Tile 3617:
##.##....#
..#.......
##.......#
#...##..#.
.........#
.........#
#.#....#..
##........
#.......##
###.#.###.

Tile 3019:
.###...#..
..#.#....#
#....#...#
...#......
.#.###...#
#...#.....
#.##.#..##
#.........
.#.......#
..#..#...#

Tile 3049:
###...#...
.#.......#
#..#..#...
........#.
#.........
##..#.....
....#....#
...###...#
...##....#
###..##.##

Tile 2341:
..#...#...
...#....#.
#........#
...#.#....
##.....#..
...#.....#
......#.##
#.#.#....#
.#....#...
#..###....

Tile 2837:
.###..#.##
.#........
.#.....#..
#..####..#
#.........
#........#
..........
##.......#
.#.......#
...##.#...

Tile 3571:
###.#..##.
....#...##
.......#.#
......#..#
.#.......#
......#...
..#....#.#
#........#
..........
##.#.##...

Tile 1987:
#...#..##.
##..#.#...
#.........
#.#......#
.#......##
.#.#......
...##..#.#
.........#
##..#..###
#.##.#...#

Tile 1979:
#..##..##.
..........
..........
...#.....#
........##
..#...#..#
##.....#.#
#......#.#
#..#....#.
....#.#..#

Tile 1933:
##..#.#.##
##........
.........#
........#.
.........#
..........
#.##.#....
#..#.....#
#.#.#.....
....#...##

Tile 1607:
.#.....#.#
#...#....#
......#..#
#........#
.......#..
#.#...####
..####...#
....#....#
#.........
##...###..

Tile 3119:
#.......##
##......#.
#.#.......
#.........
........#.
#...#.....
#.....#..#
##.#....#.
#.##......
...##.####

Tile 3923:
...##...##
#..#.....#
##..#..###
........##
.###......
...#.##..#
#.......##
.......##.
#.....##..
##.#.....#

Tile 3917:
######.#..
..........
.#.....#.#
#.....##.#
#...##...#
#.....#...
#....##...
##.#...#.#
.......#..
.#.#.##.##

Tile 3313:
..#...###.
#...###...
..#......#
#......#..
..........
...#...#..
#.....##.#
#.....##..
#...#.#.#.
.#....#..#

Tile 3083:
###.....#.
..#....#..
#.........
###......#
##....#...
..#......#
###......#
#....#....
#.#.#.#..#
....#...#.

Tile 1733:
#...##..#.
..........
#....#....
..#...#..#
#.#...#..#
........##
#.###....#
#.#....#.#
#..##..#..
...#.###.#

Tile 1789:
.##...###.
##..##...#
..#.......
#......#..
#.......#.
.##.#.#...
...#.....#
..##....##
#.......#.
..#.....##

Tile 1153:
.#...#.##.
.........#
#..#..#...
.......#.#
#.........
..#.....##
.........#
#....#....
##......##
.#.##...##

Tile 3361:
..###.####
....#.....
#....#.#.#
.#......##
..........
#...#..#.#
#......#.#
...#.#.#..
....#.#..#
##..##...#

Tile 1973:
.#.......#
##.#..#...
....#..#.#
.........#
#....#..##
#.#.......
##.##..#.#
..#.......
...#.#.#.#
#....#.#..

Tile 2917:
.#.##.#...
....#....#
#....#....
..#......#
........##
#........#
....#...##
#......#.#
..#......#
..##.##.#.

Tile 2833:
.#.##..###
..#......#
#...#....#
#.#.......
#.#..#....
#.#..#..#.
....#...##
..##......
#.#..#....
##..######

Tile 2287:
#..###..##
#.#..##.#.
##.#..##..
#.#.......
........#.
#........#
..........
..##.#..#.
.#.#..####
###....##.

Tile 2207:
.#..######
#...#.....
#........#
..#.#.....
..........
..........
#.#....#.#
..#....#.#
..#...#...
##.#....#.

Tile 1439:
.....####.
#.......##
#...#..#..
#.........
#........#
###.......
#.......##
#..#......
.....#.###
###..#..#.

Tile 1669:
###.###.##
#....#.#..
####....#.
#.##.#..##
.......#..
#.#......#
.......###
#......#.#
#...#...##
...#..#.##

Tile 2593:
.###..#...
##........
....#.....
#........#
#...#.#...
#.#.#...#.
#.........
.........#
..#...#..#
#.##.#.##.

Tile 3769:
.#.#.#.#..
.......###
#.....#...
.......#.#
##........
..#.....##
.........#
..#...#..#
##...#...#
...#.##..#

Tile 2111:
#..##.#.#.
....#.#...
###.##.#..
#...##....
.##.#..#..
...##.#.#.
##.......#
#....#....
......#..#
..##.#..#.
"
import StatsBase.countmap
import Base.Iterators.flatten

# julia weirdness, a small price to pay for the built in matrix operations
import Base.transpose
transpose(c::Char) = c

photo_parts = []

const Pixels = Array{Char, 2}

function num_from_binary_rep(a::Vector{Char}) :: Int
    parse(Int, join(c == '#' ? 1 : 0 for c in a), base = 2)
end

struct PhotoPart
    tile_id::Int
    pixels::Pixels
end

function all_rotations(pixels)
    Channel() do channel
        # no rotation
        put!(channel, pixels)

        pixels = rotr90(pixels)
        # one rotation
        put!(channel, pixels)

        pixels = rotr90(pixels)
        # two rotations
        put!(channel, pixels)

        pixels = rotr90(pixels)
        # three rotations
        put!(channel, pixels)
    end
end

function all_flips(pixels_orig)
    Channel() do channel
        put!(channel, pixels_orig)
        put!(channel, reverse(pixels_orig, dims=1))
        put!(channel, reverse(pixels_orig, dims=2))
    end
end

function all_rotations_and_flips(pixels)
    s = Set()
        for flip in all_flips(pixels)
            for rotation in all_rotations(flip)
                push!(s, rotation)
            end
        end
    s
end

function all_perms(pixels::Pixels)
    ps = Set()
    for pixels in all_rotations_and_flips(pixels)
        top_edge = num_from_binary_rep(pixels[1, :])
        bottom_edge = num_from_binary_rep(pixels[10, :])
        left_edge = num_from_binary_rep(pixels[:, 1])
        right_edge = num_from_binary_rep(pixels[:, 10])
        push!(ps, Perm(top_edge, bottom_edge, left_edge, right_edge))
    end
    ps
end

global current_tile_id = nothing
current_tile_lines = Vector{Char}[]
for line in split(DEMO, "\n")
    if startswith(line, "Tile")
        global current_tile_id = parse(Int, strip(line, collect("Tile :")))
    elseif line == ""
        pixels = mapreduce(transpose, vcat, current_tile_lines)
        push!(photo_parts, PhotoPart(current_tile_id, pixels))
        empty!(current_tile_lines)
    else
        push!(current_tile_lines, collect(line) :: Vector{Char})
    end
end

struct Perm
    top_edge::Int
    left_edge::Int
    right_edge::Int
    bottom_edge::Int
    # inner_photo::Pixels
end

struct NoTileThere
end

mutable struct PlacedTile
    tile_id
    top::Union{PlacedTile,Nothing, NoTileThere}
    bottom::Union{PlacedTile,Nothing, NoTileThere}
    left::Union{PlacedTile,Nothing, NoTileThere}
    right::Union{PlacedTile,Nothing, NoTileThere}
    remaining_permutations::Set{Perm}
end

function possible_bottom_vals(pt::PlacedTile)
    map(perm -> perm.bottom_edge, collect(pt.remaining_permutations))
end

function possible_top_vals(pt::PlacedTile)
    map(perm -> perm.top_edge, collect(pt.remaining_permutations))
end

function possible_left_vals(pt::PlacedTile)
    map(perm -> perm.left_edge, collect(pt.remaining_permutations))
end

function possible_right_vals(pt::PlacedTile)
    map(perm -> perm.right_edge, collect(pt.remaining_permutations))
end

all_placed_tiles = map(photo_parts) do photo_part
    PlacedTile(photo_part.tile_id, nothing, nothing, nothing, nothing, all_perms(photo_part.pixels))
end

function find_one_matching_point(src_possible_vals, dest_possible_vals)
    first(intersect(src_possible_vals, dest_possible_vals))
end

function look_for_unresolved_tiles(all_placed_tiles)
    filter(all_placed_tiles) do pt
        length(pt.remaining_permutations) > 1 ||
            nothing in [pt.top, pt.left, pt.bottom, pt.right]
    end
end

while true
    local unresolved_tiles = look_for_unresolved_tiles(all_placed_tiles)
    if isempty(unresolved_tiles)
        break
    end

    for src_tile in unresolved_tiles
        if src_tile.top == nothing
            dest_tile = filter(all_placed_tiles) do cand_tile
                (cand_tile !== src_tile && (cand_tile.bottom == nothing) &&
                 !isempty(intersect(possible_top_vals(src_tile), possible_bottom_vals(cand_tile))))
            end
            if !isempty(dest_tile)
                dest_tile = first(dest_tile)
                match_points = intersect(possible_top_vals(src_tile), possible_bottom_vals(dest_tile))
                src_tile.top = dest_tile
                dest_tile.bottom = src_tile
                filter!(perm -> perm.top_edge in match_points, src_tile.remaining_permutations)
                filter!(perm -> perm.bottom_edge in match_points, dest_tile.remaining_permutations)
            else
                src_tile.top = NoTileThere()
            end
        end
        if src_tile.bottom == nothing
            dest_tile = filter(all_placed_tiles) do cand_tile
                (cand_tile !== src_tile && (cand_tile.top == nothing) &&
                 !isempty(intersect(possible_bottom_vals(src_tile), possible_top_vals(cand_tile))))
            end

            if !isempty(dest_tile)
                dest_tile = first(dest_tile)

                match_points = intersect(possible_bottom_vals(src_tile), possible_top_vals(dest_tile))
                src_tile.bottom = dest_tile
                dest_tile.top = src_tile

                filter!(perm -> perm.bottom_edge in match_points, src_tile.remaining_permutations)
                filter!(perm -> perm.top_edge in match_points, dest_tile.remaining_permutations)
            else
                src_tile.bottom = NoTileThere()
            end
        end
        if src_tile.left == nothing
            dest_tile = filter(all_placed_tiles) do cand_tile
                (cand_tile !== src_tile && (cand_tile.right == nothing) &&
                 !isempty(intersect(possible_left_vals(src_tile), possible_right_vals(cand_tile))))
            end

            if !isempty(dest_tile)
                dest_tile = first(dest_tile)
                match_points = intersect(possible_left_vals(src_tile), possible_right_vals(dest_tile))
                src_tile.left = dest_tile
                dest_tile.right = src_tile

                filter!(perm -> perm.left_edge in match_points, src_tile.remaining_permutations)
                filter!(perm -> perm.right_edge in match_points, dest_tile.remaining_permutations)
            else
                src_tile.left = NoTileThere()
            end
        end
        if src_tile.right == nothing
            dest_tile = filter(all_placed_tiles) do cand_tile
                (cand_tile !== src_tile && (cand_tile.left == nothing) &&
                 !isempty(intersect(possible_right_vals(src_tile), possible_left_vals(cand_tile))))
            end

            if !isempty(dest_tile)
                dest_tile = first(dest_tile)
                match_points = intersect(possible_right_vals(src_tile), possible_left_vals(dest_tile))
                src_tile.right = dest_tile
                dest_tile.left = src_tile

                filter!(perm -> perm.right_edge in match_points, src_tile.remaining_permutations)
                filter!(perm -> perm.left_edge in match_points, dest_tile.remaining_permutations)
            else
                src_tile.right = NoTileThere()
            end
        end
    end
end
